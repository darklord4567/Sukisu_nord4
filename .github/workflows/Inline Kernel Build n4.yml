name: GKI Kernel Image.gz Only Build (With Prebuilts Manifest)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison build-essential ccache flex \
            git libssl-dev python3 rsync unzip zip zlib1g-dev \
            libncurses5-dev libelf-dev lz4 device-tree-compiler curl

      - name: Install Repo Tool
        run: |
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/repo
          chmod a+x ~/repo
          sudo mv ~/repo /usr/local/bin/repo

      - name: Init Repo & Add Local Manifest (Prebuilts + Kernel Only)
        run: |
          mkdir kernel_workspace && cd kernel_workspace

          # Init repo with correct AOSP kernel manifest branch
          repo init -u https://android.googlesource.com/kernel/manifest -b common-android14-6.1 --depth=1

          # Add your local manifest to override/add projects
          mkdir -p .repo/local_manifests
          cat <<EOF > .repo/local_manifests/local_manifest.xml
          <?xml version="1.0" encoding="UTF-8"?>
          <manifest>
            <remote name="aosp" fetch="https://android.googlesource.com" />
            <remote name="github" fetch="https://github.com/OnePlusOSS" />
            <default revision="common-android14-6.1" remote="aosp" sync-j="4" />
            <project path="build" name="kernel/build" />
            <project path="kernel/tests" name="kernel/tests" />
            <project path="kernel/configs" name="kernel/configs" />
            <project path="prebuilts/build-tools" name="platform/prebuilts/build-tools" clone-depth="1" />
            <project path="prebuilts/kernel-build-tools" name="kernel/prebuilts/build-tools" clone-depth="1" />
            <project path="prebuilts-master/clang/host/linux-x86" name="platform/prebuilts/clang/host/linux-x86" clone-depth="1" />
            <project path="prebuilts/gcc/linux-x86/host/x86_64-linux-glibc2.17-4.8" name="platform/prebuilts/gcc/linux-x86/host/x86_64-linux-glibc2.17-4.8" clone-depth="1" />
            <project path="kernel-5.10" name="android_kernel_5.10_oneplus_mt6983" remote="github" revision="oneplus/mt6983_v_15.0.0_nord_3" clone-depth="1" />
          </manifest>
          EOF

          echo "===== Local Manifest ====="
          cat .repo/local_manifests/local_manifest.xml


      - name: Sync Prebuilts & Kernel Source
        run: |
          cd kernel_workspace
          
          echo "===== SYNCING ====="
          repo sync -c --no-tags --no-clone-bundle --force-sync -j$(nproc --all)

      - name: Build Kernel (Image.gz Only)
        run: |
          cd kernel_workspace/kernel-5.10
          export ARCH=arm64
          export SUBARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export LOCALVERSION="-custom"
          export PATH=$GITHUB_WORKSPACE/kernel_workspace/prebuilts-master/clang/host/linux-x86/clang-r416183b/bin:$PATH
          export PATH="/usr/lib/ccache:$PATH"
          export CC="ccache clang"

          make O=out gki_defconfig
          make O=out -j$(nproc --all) Image.gz

      - name: Upload Built Image.gz
        uses: actions/upload-artifact@v4
        with:
          name: Built-Image.gz
          path: kernel_workspace/kernel-5.10/out/arch/arm64/boot/Image.gz
